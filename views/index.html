<html ng-app="ESPlus">
<head>
	<link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap.min.css">

    <style>
        table {
            width: 1000px;
        }

        thead, tbody { display: block; }

        tbody {
            overflow-y: auto;
            overflow-x: hidden;
        }

        tbody td, thead th {
            width: 20%;  /* Optional */
        }

        tbody input {
            width: 100%;
        }
    </style>

<!--	<script type="text/javascript" src="http://10.0.0.42:3000/javascripts/socket.io.js"></script>-->
<!--	<script type="text/javascript" src="http://192.168.56.100:3000/javascripts/socket.io.js"></script>-->
	<script type="text/javascript" src="/javascripts/socket.io.js"></script>
<!--    <script type="text/javascript" src="/javascripts/firebase.js"></script>-->
    <script type="text/javascript" src="/javascripts/angular.min.js"></script>
    <script type="text/javascript" src="/javascripts/angular-ui.min.js"></script>
    <script type="text/javascript" src="/javascripts/angular-ui-router.min.js"></script>
</head>
<body ng-controller="MainCtrl">

<div style="margin-left:50px;">
    <h1>ES+Firebase Web Client</h1>
	<div>
		<label>Count Received: {{countReceived}}</label> <br />
		<label>Single Perf Limit: <input ng-model="singlePerfLimit" /></label>
	</div><br />

	<button ng-click="setLocalFb()">Local fb!</button>
    <button ng-click="createEntity()">Create!</button>
	<button ng-click="createFast()">Create Fast!</button>

    <table style="height: 30px;">

        <tbody style="border: solid thin black; height:150px;">
            <tr>
                <td>{{selectedKey}}</td>
                <td>{{selected.Id}}</td>
                <td><input ng-model="selected.Name"/></td>
                <td><input ng-model="selected.WhichEntity" /></td>
                <td><button ng-click="updateEntity()">Update!</button></td>
                <td><button ng-click="addRow()">Add Row!</button></td>
				<td><button ng-click="runSinglePerf()">Perf This!</button></td>
				<td><button ng-click="postEvent()">Post Event!</button></td>
            </tr>
             <tr ng-repeat="step in selected.Steps">
                <td><input ng-model="step.Name" /></td>
                <td><input type="date" ng-model="step.Start" /></td>
                <td>{{step.Start}}</td>
                <td><input type="date" ng-model="step.End" /></td>
                <td><input ng-model="step.Note" /></td>
            </tr>
        </tbody>

        <tbody style="height:250px;">
            <tr ng-repeat="(key,val) in model" ng-if="key != '_metadata'">
                <td>{{key}}</td>
                <td>{{val.Id}}</td>
                <td><input ng-disabled="true" ng-model="val.Name" /></td>
                <td><input ng-disabled="true" ng-model="val.WhichEntity" /></td>
                <td><button ng-click="selectEntity(key,val)">Edit</button></td>
            </tr>
        </tbody>

    </table>

</div>

    <footer>
        <p>&copy; 2014, Brandon Wilhite</p>
    </footer>


<script type="text/javascript">
//	var _base = 'http://10.0.0.42:3000';
//	var _base = 'http://192.168.56.100:3000';// '' for localhost
	var _base = '';

	var onValue = function(data){};

	var getRef = function(path){
		var root = io(_base);

		root.on('subscribed',function(path){
			console.log('server ack ' + path);
			var socket = io(_base + path);

			socket.on('value',function(data){
				onValue(data);
			});
		});

		root.on('connect',function(){
			console.log('subscribing to /TestOrg');
			root.emit('subscribe','/TestOrg/current');
		});
	};


/*
	var getRef = function(path){
		myFirebaseRef = new Firebase("https://test-workflow.firebaseio.com" + path);

		myFirebaseRef.child("current").on("value", function(snapshot) {
			onValue(snapshot.val());
		});
	};
*/

    function runScope(angularScope,callback){

		var result = void 0;
		var phase = angularScope.$root.$$phase;

		if(phase == '$apply' || phase == '$digest'){
			result = callback(angularScope);
		}else{
			angularScope.$apply(function(){
				result = callback(angularScope);
			});
		}

	    return result;
	}

</script>
<script type="text/javascript">

angular.module('ESPlus',[])
.controller('MainCtrl',['$scope','$http','$log',function($scope,$http,$log){

    $scope.model = {};
    $scope.selected = { };
    $scope.selectedKey = '';

    $scope.addRow = function(){
        if(!$scope.selected.Steps) $scope.selected.Steps = [];

        $scope.selected.Steps.push({Name: 'StepName', Start: new Date(), End: new Date(), Note: 'Note'});
    };

    $scope.selectEntity = function(key,val){
        $scope.selected = val;
        $scope.selectedKey = key;
    };

	$scope.setLocalFb = function(){
		$http.post('/Store/TestOrg/current',
		{
			WhichEntity: 18,
			Name: "Uncle Fester",
			_metadata: { }
		})
		.then(function(data){
			$log.log('http success: ' + JSON.stringify(data));
		})
		.catch(function(err){
			$log.log('http error: ' + JSON.stringify(err));
		});
	};

    $scope.createEntity = function() {

        $http.post('/Entity1',
        {
            WhichEntity: 18,
            Name: "Uncle Fester",
            _metadata: { }
        })
        .then(function(data){
            $log.log('http success: ' + JSON.stringify(data));
        })
        .catch(function(err){
            $log.log('http error: ' + JSON.stringify(err));
        });

    };

	$scope.createFast = function() {

		$http.post('/Fastlane/Entity1',
		{
			WhichEntity: 18,
			Name: "Uncle Fester",
			_metadata: { }
		})
		.then(function(data){
			$log.log('http success: ' + JSON.stringify(data));
		})
		.catch(function(err){
			$log.log('http error: ' + JSON.stringify(err));
		});

	};

	$scope.postEvent = function(){
		//note: angularjs requires us to escape the colon
		$http.post('http://localhost\:4000/Event',
		{
			WhichEntity: 18,
			Name: "Morticia",
			_metadata: { }
		})
		.then(function(data){
			$log.log('http success: ' + JSON.stringify(data));
		})
		.catch(function(err){
			$log.log('http error: ' + JSON.stringify(err));
		});

	};

    $scope.updateEntity = function(){

        $http.put('/Entity1',$scope.selected)
        .then(function(data){
            $log.log('http success: ' + JSON.stringify(data));
        })
        .catch(function(err){
            $log.log('http error: ' + JSON.stringify(err));
        });

    };

	var modelUpdate = function(snapshot){

		runScope($scope,function(){
			var _model = snapshot;

			for(var ent in _model){
				if(_model[ent].Steps && _model[ent].Steps.length){
					for(var i = 0, l = _model[ent].Steps.length; i < l; i++){
						var curr = _model[ent].Steps[i];
						curr.Start = new Date(curr.Start);
						curr.End = new Date(curr.End);
					}
				}
			}

			$scope.model = _model;
		});
	};

	onValue = modelUpdate;

//	getRef();


	//PERF OVER A SINGLE ENTITY, SINGLE STREAM
	$scope.countReceived = 0;
	$scope.singlePerfLimit = 1000;
	var perfMax = $scope.singlePerfLimit;
	var singlePerfStart = new Date();
	var perfReceived = 0;

	var checkEnd = function(){
		if(perfReceived >= perfMax){
			var _now = new Date();
			console.log('end perf ' + _now);
			onValue = modelUpdate;

			var t1 = _now;
			var t2 = singlePerfStart;
			var dif = t1.getTime() - t2.getTime()

			var Seconds_from_T1_to_T2 = dif / 1000;
			var Seconds_Between_Dates = Math.abs(Seconds_from_T1_to_T2);
			console.log('It took ' + Seconds_from_T1_to_T2 + ' seconds to process ' + $scope.singlePerfLimit + ' records');
			console.log('that is ' + ($scope.singlePerfLimit / Seconds_from_T1_to_T2) + ' records/sec');

		}
	};

	var onSinglePerf = function(snapshot){
		perfReceived++;

		if(perfReceived % 100 === 0){
			runScope($scope,function(){
				$scope.countReceived = perfReceived;
			});
		}

		checkEnd();
	};

	$scope.runSinglePerf = function(){
		perfReceived = 0;
		perfMax = $scope.singlePerfLimit;
		onValue = onSinglePerf;
		console.log('perfMax ' + perfMax)


		singlePerfStart = new Date();
		console.log('start perf ' + singlePerfStart);

		for(var i = 1, l = $scope.singlePerfLimit; i <= l; i++){
			var errors = 0;
			$scope.selected.WhichEntity = i;
			$http.put('/Fastlane/Entity1',$scope.selected)
			.catch(function(err){
				errors++;
				$log.log('perf POST error count: ' + errors);
				perfMax--;
				checkEnd();
			});
		}
	};

}])

;

</script>

</body>
</html>
